<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.atlas.dao.CatDAO">
    <select id="recommend" resultMap="Catr">
        select cid,sum(liked) liked,name from picture where fid is null group by cid order by liked desc limit 10
    </select>

    <resultMap id="Catr" type="com.atlas.entity.Cat">
        <id column="cid" property="cid"></id>
        <result column="name" property="name"></result>
        <result column="liked" property="liked"></result>
        <collection property="picture" select="findpicture" column="cid"></collection>
    </resultMap>

    <select id="catdetail" parameterType="Picture" resultMap="Catmap">
        select c.* from cat c,picture p where pid=#{pid} and p.cid=c.cid
    </select>

    <resultMap id="Catmap" type="com.atlas.entity.Cat">
        <result property="name" column="name"></result>
        <result property="color" column="color"></result>
        <result property="place" column="place"></result>
        <result property="cid" column="cid"></result>
        <result property="character" column="character"></result>
        <collection property="pictureList" ofType="com.atlas.entity.Picture" select="catdetail2" column="cid">
        </collection>
        <collection property="commentList" ofType="com.atlas.entity.Comment" select="findcomment" column="cid">
            <result property="profile_photo" column="profile_photo"></result>
            <result property="name" column="name"></result>
        </collection>
    </resultMap>

    <select id="catdetail2" resultType="Picture">
        select * from picture where cid=#{cid}
    </select>

    <select id="finduser" resultType="User">
        select u.profile_photo,u.name from user where uid=#{uid}
    </select>

    <select id="findcomment" resultType="Comment">
        select u.*,c.* from comment c,user u where c.cid=#{cid} and u.uid=c.uid order by date desc
    </select>

    <select id="search" parameterType="Picture" resultType="Cat">
        select * from cat where name like concat('%',#{information},'%')
                        or color like concat('%',#{information},'%')
                        or place like concat('%',#{information},'%')
    </select>

    <resultMap id="gbcolor" type="com.atlas.entity.Cat">
        <id property="cid" column="cid"></id>
        <result property="color" column="color"></result>
        <result property="cid" column="cid"></result>
        <result property="name" column="name"></result>
        <collection property="picture" select="findpicture" column="cid"></collection>
    </resultMap>

    <select id="findpicture" resultType="Picture">
        select * from picture where cid=#{cid} order by rand() limit 1
    </select>

    <select id="findall" parameterType="Cat" resultMap="gbcolor">
        select c.*  from cat c where color=#{color}
    </select>

    <select id="findcolor" resultMap="Catcolor">
        select distinct color,name from cat group by color
    </select>

    <resultMap id="Catcolor" type="com.atlas.entity.Cat">
        <result property="color" column="color"></result>
        <collection property="picture" select="findpicture2" column="name"></collection>
    </resultMap>

    <select id="findpicture2" resultType="Picture">
        select * from picture where name=#{name} limit 1
    </select>
</mapper>